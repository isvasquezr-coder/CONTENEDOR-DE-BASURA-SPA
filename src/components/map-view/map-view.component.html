<div class="bg-gray-800 rounded-lg shadow-lg p-4 h-full">
  <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Mapa de Contenedores</h2>
  <div class="relative w-full h-[calc(100vh-150px)] rounded-md overflow-hidden border-2 border-gray-700"
       style="background-image: url('https://aistudiocdn.com/media/maps/satellite.png'); background-size: cover; background-position: center;">
    
    <!-- Grid Overlay -->
    <div class="absolute inset-0" style="background-image: linear-gradient(rgba(0, 0, 0, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.2) 1px, transparent 1px); background-size: 40px 40px;"></div>

     <!-- SVG Layer for Truck Route -->
    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
      <defs>
        <marker id="arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="3.5" markerHeight="3.5" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#34D399"></path>
        </marker>
      </defs>
      <polyline 
        [attr.points]="truckPathPoints()"
        fill="none" 
        stroke="#34D399" 
        stroke-width="0.8" 
        stroke-linecap="round"
        marker-mid="url(#arrowhead)"
        style="filter: drop-shadow(0 0 5px #34D399);" />
    </svg>

    <!-- Container Markers -->
    @for (container of containers(); track container.id) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group transition-transform duration-200" 
        [style.left.%]="(container.location.gridX / 20) * 100" 
        [style.top.%]="(container.location.gridY / 20) * 100"
        (click)="selectContainer(container.id)"
        [class.scale-125]="selectedContainerId() === container.id"
        [class.z-20]="selectedContainerId() === container.id">
        
        @if (container.status === 'Pickup Required') {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full opacity-75 animate-ping" 
                 [class]="getMarkerBgClass(container.status)">
            </div>
        }
        
         <div class="relative w-7 h-7 drop-shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-full h-full">
            <path [attr.fill]="getContainerColor(container.status)" stroke="#111827" stroke-width="1" d="M20 6h-4V5a1 1 0 00-1-1h-6a1 1 0 00-1 1v1H4a1 1 0 00-1 1v2h18V7a1 1 0 00-1-1zM5 10v10a2 2 0 002 2h10a2 2 0 002-2V10H5z" />
          </svg>
           <!-- Fill level bar (inverted) -->
          <div class="absolute bottom-0 left-0 right-0 h-full bg-black/30 rounded-b-sm" [style.height.%]="100 - container.fillLevel"></div>
        </div>

        <div class="absolute bottom-full mb-2 w-max bg-gray-900 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 left-1/2 -translate-x-1/2 z-30 whitespace-nowrap">
            {{ container.id }} - {{ container.fillLevel.toFixed(0) }}% Lleno
             <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-gray-900"></div>
        </div>
      </div>
    }

     <!-- Truck Marker -->
    @if (truck(); as truck) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 ease-linear z-10"
        [style.left.%]="(truck.location.gridX / 20) * 100" 
        [style.top.%]="(truck.location.gridY / 20) * 100">
          <div class="w-8 h-8 text-green-300">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-full h-full drop-shadow-lg">
              <path d="M20.57 8.36L19 7V6c0-1.1-.9-2-2-2h-3.48c-.46-1.28-1.7-2-3.02-2s-2.56.72-3.02 2H4c-1.1 0-2 .9-2 2v1h15.43l1.87 2.8c.24.35.68.51 1.1.39.42-.12.7-.51.7-.96V9c0-.4-.24-.76-.63-.94zM12 2c.41 0 .78.25.92.62.15.37.15.79 0 1.16C12.78 4.15 12.41 4.4 12 4.4s-.78-.25-.92-.62c-.15-.37-.15-.79 0-1.16C11.22 2.25 11.59 2 12 2zM4 9v9c0 1.1.9 2 2 2h1c0 1.1.9 2 2 2s2-.9 2-2h4c0 1.1.9 2 2 2s2-.9 2-2h1c1.1 0 2-.9 2-2v-9H4zm7 11c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
            </svg>
            @if(truck.status === 'On Route') {
              <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse border-2 border-gray-800"></div>
            }
          </div>
      </div>
    }
  </div>
</div>