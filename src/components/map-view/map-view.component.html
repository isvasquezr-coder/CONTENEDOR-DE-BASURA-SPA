<div class="bg-gray-800 rounded-lg shadow-lg p-4 h-full">
  <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Mapa de Contenedores</h2>
  <div class="relative w-full h-[calc(100vh-150px)] rounded-md overflow-hidden border-2 border-gray-700">
    
    <!-- SVG Layer for Map background, Truck Route -->
    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
        <!-- Map Base -->
        <rect width="100" height="100" fill="#1e293b" />

        <!-- River -->
        <rect x="30" y="0" width="10" height="100" fill="#334155" />

        <!-- Roads -->
        <g fill="#475569">
            <rect x="0" y="20" width="100" height="5" />
            <rect x="0" y="45" width="100" height="5" />
            <rect x="0" y="70" width="100" height="5" />
            <rect x="15" y="0" width="5" height="100" />
            <rect x="55" y="0" width="5" height="100" />
            <rect x="85" y="0" width="5" height="100" />
        </g>
      
        <!-- Buildings -->
        <g fill="#0f172a" stroke="#475569" stroke-width="0.2">
            <rect x="2" y="2" width="10" height="15" />
            <rect x="2" y="28" width="10" height="15" />
            <rect x="2" y="52" width="10" height="15" />
            <rect x="2" y="78" width="10" height="20" />
            <rect x="22" y="5" width="5" height="10" />
            <rect x="22" y="28" width="5" height="40" />
            <rect x="22" y="78" width="5" height="15" />
            <rect x="42" y="8" width="10" height="30" />
            <rect x="42" y="52" width="10" height="15" />
            <rect x="42" y="78" width="10" height="20" />
            <rect x="62" y="2" width="20" height="15" />
            <rect x="62" y="28" width="20" height="15" />
            <rect x="62" y="52" width="20" height="46" />
            <rect x="92" y="5" width="6" height="38" />
            <rect x="92" y="52" width="6" height="46" />
        </g>

        <!-- Truck Route -->
        <polyline 
            [attr.points]="truckPathPoints()"
            fill="none" 
            stroke="#4f46e5" 
            stroke-width="1.2" 
            stroke-linecap="round"
            stroke-linejoin="round"
            style="filter: drop-shadow(0 0 5px #4f46e5);" />
    </svg>

    <!-- Depot Marker -->
    <div class="absolute transform -translate-x-1/2 -translate-y-1/2 group" style="left: 2.5%; top: 50%;">
      <div class="relative w-8 h-8">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#a5b4fc" class="w-full h-full drop-shadow-lg">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path>
        </svg>
      </div>
      <div class="absolute bottom-full mb-2 w-max bg-white text-gray-800 text-xs font-semibold rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 left-1/2 -translate-x-1/2 z-30 shadow-lg">
          Dep√≥sito
          <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-white"></div>
      </div>
    </div>

    <!-- Container Markers -->
    @for (container of containers(); track container.id) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group transition-transform duration-200" 
        [style.left.%]="(container.location.gridX / 20) * 100" 
        [style.top.%]="(container.location.gridY / 20) * 100"
        (click)="selectContainer(container.id)"
        [class.scale-125]="selectedContainerId() === container.id"
        [class.z-20]="selectedContainerId() === container.id">
        
        @if (container.status === 'Pickup Required') {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-full opacity-75 animate-ping bg-red-500">
            </div>
        }

        @if (selectedContainerId() === container.id) {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 rounded-full border-2 border-cyan-400 animate-ping"></div>
        }

        @if (targetContainerIds().includes(container.id)) {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-14 h-14 rounded-full border-2 border-green-400 animate-ping opacity-75"></div>
        }
        
        <div class="relative w-8 h-10">
          <svg viewBox="0 0 32 40" class="w-full h-full drop-shadow-lg">
            <path [attr.fill]="getContainerColor(container.status)" d="M16 0C7.163 0 0 7.163 0 16c0 10 16 24 16 24s16-14 16-24C32 7.163 24.837 0 16 0z"></path>
            <circle cx="16" cy="16" r="12" fill="rgba(0,0,0,0.4)"></circle>
            <circle cx="16" cy="16" r="10" fill="transparent" stroke="#1e293b" stroke-width="3"></circle>
            <circle cx="16" cy="16" r="10" fill="transparent" 
                    [attr.stroke]="getFillLevelStrokeClass(container.fillLevel)" 
                    stroke-width="3" 
                    stroke-linecap="round"
                    transform="rotate(-90 16 16)"
                    [attr.stroke-dasharray]="62.8318"
                    [attr.stroke-dashoffset]="62.8318 * (1 - (container.fillLevel / 100))">
            </circle>
            <text x="16" y="19.5" font-family="monospace" font-size="8" fill="white" text-anchor="middle">{{ container.fillLevel.toFixed(0) }}%</text>
          </svg>
        </div>

        <div class="absolute bottom-full mb-3 w-max bg-white text-gray-800 text-xs font-semibold rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 left-1/2 -translate-x-1/2 z-30 shadow-lg whitespace-nowrap">
            {{ container.id }}
             <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-white"></div>
        </div>
      </div>
    }

     <!-- Truck Marker -->
    @if (truck(); as truck) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-100 ease-linear z-10"
        [style.left.%]="(truck.location.gridX / 20) * 100" 
        [style.top.%]="(truck.location.gridY / 20) * 100">
        
        @if (truck.isCleaning) {
          <div class="absolute -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 w-10 h-10 rounded-full border-2 border-cyan-400 animate-spin"></div>
        }
        
        <div class="relative w-7 h-7 transition-transform duration-300" [style.transform]="'rotate(' + truckRotation() + 'deg)'">
           <svg viewBox="0 0 24 24" class="w-full h-full drop-shadow-lg">
              <circle cx="12" cy="12" r="11" [attr.fill]="truckMarkerColor()" stroke="white" stroke-width="1.5"></circle>
              <path d="M12 6 L17 14 L12 11.5 L7 14 Z" fill="white"></path>
          </svg>
        </div>

      </div>
    }
  </div>
</div>
