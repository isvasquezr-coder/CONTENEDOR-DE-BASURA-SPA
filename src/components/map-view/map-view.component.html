<div class="bg-gray-800 rounded-lg shadow-lg p-4 h-full">
  <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Mapa de Contenedores</h2>
  <div class="relative w-full h-[calc(100vh-150px)] rounded-md overflow-hidden border-2 border-gray-700"
       style="background-image: url('https://aistudiocdn.com/media/maps/dark-map-texture.png'); background-size: cover; background-position: center;">
    
    <!-- Vignette Effect -->
    <div class="absolute inset-0 pointer-events-none" style="box-shadow: inset 0 0 100px 40px rgba(0,0,0,0.8);"></div>
    
     <!-- SVG Layer for Truck Route & City Buildings -->
    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
      <defs>
        <marker id="arrowhead" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="3.5" markerHeight="3.5" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#34D399"></path>
        </marker>
        <radialGradient id="headlight-gradient">
          <stop offset="0%" stop-color="rgba(255, 255, 224, 0.8)" />
          <stop offset="100%" stop-color="rgba(255, 255, 224, 0)" />
        </radialGradient>
      </defs>

      <!-- Building Outlines for depth -->
      <g fill="rgba(255, 255, 255, 0.05)" stroke="rgba(255, 255, 255, 0.1)" stroke-width="0.1">
        <rect x="5" y="5" width="15" height="10" />
        <rect x="25" y="8" width="10" height="20" />
        <rect x="40" y="2" width="20" height="12" />
        <rect x="65" y="10" width="15" height="15" />
        <rect x="85" y="5" width="10" height="25" />
        <rect x="5" y="20" width="18" height="15" />
        <rect x="30" y="35" width="30" height="10" />
        <rect x="65" y="30" width="25" height="20" />
        <rect x="10" y="40" width="15" height="25" />
        <rect x="40" y="50" width="20" height="20" />
        <rect x="70" y="55" width="20" height="35" />
        <rect x="5" y="70" width="30" height="10" />
        <rect x="45" y="75" width="20" height="15" />
      </g>

      <polyline 
        [attr.points]="truckPathPoints()"
        fill="none" 
        stroke="#34D399" 
        stroke-width="0.8" 
        stroke-linecap="round"
        stroke-dasharray="3 3"
        marker-mid="url(#arrowhead)"
        style="filter: drop-shadow(0 0 5px #34D399);" />
    </svg>

    <!-- Container Markers -->
    @for (container of containers(); track container.id) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group transition-transform duration-200" 
        [style.left.%]="(container.location.gridX / 20) * 100" 
        [style.top.%]="(container.location.gridY / 20) * 100"
        (click)="selectContainer(container.id)"
        [class.scale-125]="selectedContainerId() === container.id"
        [class.z-20]="selectedContainerId() === container.id">
        
        @if (container.status === 'Pickup Required') {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full opacity-75 animate-ping" 
                 [class]="getMarkerBgClass(container.status)">
            </div>
        }

        @if (selectedContainerId() === container.id) {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-full border-2 border-cyan-400 animate-ping -z-10"></div>
        }
        
         <div class="relative w-7 h-7 drop-shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-full h-full">
            <path [attr.fill]="getContainerColor(container.status)" stroke="#111827" stroke-width="1" d="M20 6h-4V5a1 1 0 00-1-1h-6a1 1 0 00-1 1v1H4a1 1 0 00-1 1v2h18V7a1 1 0 00-1-1zM5 10v10a2 2 0 002 2h10a2 2 0 002-2V10H5z" />
          </svg>
           <!-- Fill level bar (inverted) -->
          <div class="absolute bottom-0 left-0 right-0 h-full bg-black/30 rounded-b-sm" [style.height.%]="100 - container.fillLevel"></div>
        </div>

        <div class="absolute bottom-full mb-2 w-max bg-gray-900 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 left-1/2 -translate-x-1/2 z-30 whitespace-nowrap">
            {{ container.id }} - {{ container.fillLevel.toFixed(0) }}% Lleno
             <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-gray-900"></div>
        </div>
      </div>
    }

     <!-- Truck Marker -->
    @if (truck(); as truck) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-100 ease-linear z-10"
        [style.left.%]="(truck.location.gridX / 20) * 100" 
        [style.top.%]="(truck.location.gridY / 20) * 100">
        
        <div class="relative w-8 h-8 transition-transform duration-300" [style.transform]="'rotate(' + truckRotation() + 'deg)'">
            @if(truck.status === 'On Route') {
              <!-- Headlight cone -->
              <svg width="60" height="80" viewBox="0 0 60 80" class="absolute -top-[70px] -left-[26px] z-0 opacity-25">
                 <path d="M30 0 L0 80 L60 80 Z" fill="url(#headlight-gradient)"/>
              </svg>
            }

            <div class="w-8 h-8 text-green-300 relative z-10">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="currentColor" class="w-full h-full drop-shadow-lg">
                <!-- Truck Cabin -->
                <path d="M12 8 H52 V24 H12 Z" fill="#f8fafc"/>
                <!-- Windshield -->
                <path d="M16 10 H48 V20 H16 Z" fill="#020617"/>
                <!-- Truck Bed -->
                <path d="M8 24 H56 V56 H8 Z" fill="#16a34a"/>
                <!-- Bed Details -->
                <rect x="12" y="28" width="40" height="4" fill="#15803d"/>
                <rect x="12" y="36" width="40" height="4" fill="#15803d"/>
                <rect x="12" y="44" width="40" height="4" fill="#15803d"/>
                <!-- Headlights -->
                <rect x="14" y="6" width="8" height="2" fill="#facc15"/>
                <rect x="42" y="6" width="8" height="2" fill="#facc15"/>
                <!-- Rear lights -->
                <rect x="10" y="56" width="8" height="2" fill="#ef4444"/>
                <rect x="46" y="56" width="8" height="2" fill="#ef4444"/>
              </svg>
              @if(truck.status === 'On Route') {
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse border-2 border-gray-800"></div>
              }
            </div>
        </div>

      </div>
    }
  </div>
</div>