<div class="bg-gray-800 rounded-lg shadow-lg p-4 h-full">
  <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Mapa de Contenedores</h2>
  <div class="relative w-full h-[calc(100vh-150px)] rounded-md overflow-hidden border-2 border-gray-700"
       style="background-image: url('https://aistudiocdn.com/media/maps/satellite.png'); background-size: cover; background-position: center;">
    
     <!-- SVG Layer for Truck Route -->
    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
      <polyline 
        [attr.points]="truckPathPoints()"
        fill="none" 
        stroke="#34D399" 
        stroke-width="0.7" 
        stroke-dasharray="1.5 1.5"
        stroke-linecap="round"
        style="filter: drop-shadow(0 0 4px #34D399);" />
    </svg>

    <!-- Container Markers -->
    @for (container of containers(); track container.id) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group transition-transform duration-200" 
        [style.left.%]="(container.location.gridX / 20) * 100" 
        [style.top.%]="(container.location.gridY / 20) * 100"
        (click)="selectContainer(container.id)"
        [class.scale-125]="selectedContainerId() === container.id"
        [class.z-20]="selectedContainerId() === container.id">
        
        @if (container.status === 'Pickup Required') {
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full opacity-75 animate-ping" 
                 [class]="getMarkerBgClass(container.status)">
            </div>
        }
        
        <svg class="relative w-8 h-8 drop-shadow-lg" viewBox="0 0 24 24">
            <!-- Background circle -->
            <circle cx="12" cy="12" r="10" fill="rgba(45, 55, 72, 0.8)" stroke="#1A202C" stroke-width="1.5"></circle>
            <!-- Progress circle -->
            <circle
                cx="12"
                cy="12"
                r="10"
                fill="transparent"
                stroke-width="2"
                stroke-linecap="round"
                [attr.stroke-dasharray]="circumference"
                [attr.stroke-dashoffset]="getDonutChartOffset(container.fillLevel)"
                class="transform -rotate-90 origin-center transition-all duration-300"
                [class]="getDonutChartColorClass(container.fillLevel)"
            ></circle>
            <!-- Percentage Text -->
            <text
                x="50%"
                y="50%"
                dominant-baseline="middle"
                text-anchor="middle"
                class="text-[7px] font-bold"
                [class]="getDonutTextColorClass(container.fillLevel)"
            >
                {{ container.fillLevel.toFixed(0) }}%
            </text>
        </svg>

        <div class="absolute bottom-full mb-2 w-max bg-gray-900 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 left-1/2 -translate-x-1/2 z-30 whitespace-nowrap">
            {{ container.id }} - {{ container.location.address }}
             <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-gray-900"></div>
        </div>
      </div>
    }

     <!-- Truck Marker -->
    @if (truck(); as truck) {
      <div 
        class="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 ease-linear z-10"
        [style.left.%]="(truck.location.gridX / 20) * 100" 
        [style.top.%]="(truck.location.gridY / 20) * 100">
          <div class="w-7 h-7 text-green-300">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-full h-full drop-shadow-lg">
              <path d="M18 8a1 1 0 00-1-1h-4V4a1 1 0 00-1-1H3a1 1 0 00-1 1v11a1 1 0 001 1h1.17a2.5 2.5 0 014.66 0H14a1 1 0 001-1v-4h2a1 1 0 001-1V9a1 1 0 00-1-1zm-7 7.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM12 11V8h4v3h-4z"/>
            </svg>
            @if(truck.status === 'On Route') {
              <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse border-2 border-gray-800"></div>
            }
          </div>
      </div>
    }
  </div>
</div>